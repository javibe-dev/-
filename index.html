<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>JaVibe</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://sdk.scdn.co/spotify-player.js"></script>
    <style>
        :root {
            --primary: #6366f1;
            --primary-hover: #4f46e5;
            --glass-bg: rgba(255, 255, 255, 0.05);
            --glass-border: rgba(255, 255, 255, 0.1);
            --text-main: #ffffff;
            --text-muted: rgba(255, 255, 255, 0.6);
            --bg-dark: #09090b;
            --sidebar-bg: #111113;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Outfit', sans-serif;
        }

        body {
            min-height: 100vh;
            background: var(--bg-dark);
            color: var(--text-main);
            overflow-x: hidden;
            position: relative;
        }

        /* Snowflake Animation */
        .snowflake {
            position: fixed;
            top: -10px;
            color: white;
            font-size: 1em;
            pointer-events: none;
            z-index: 100;
            user-select: none;
            animation: fall linear infinite;
        }

        @keyframes fall {
            to {
                transform: translateY(105vh) translateX(20px);
            }
        }

        /* View Management */
        .view {
            display: none;
            height: 100vh;
            width: 100vw;
            opacity: 0;
            transition: opacity 0.4s cubic-bezier(0.2, 0.8, 0.2, 1);
        }

        .view.active {
            display: flex;
            opacity: 1;
        }

        /* --- AUTH VIEW STYLES --- */
        #authView {
            justify-content: center;
            align-items: center;
            background: #09090b;
            padding: 20px;
        }

        .bg-blob {
            position: absolute;
            width: 500px;
            height: 500px;
            background: radial-gradient(circle, rgba(99, 102, 241, 0.4) 0%, rgba(99, 102, 241, 0) 70%);
            border-radius: 50%;
            filter: blur(60px);
            z-index: 0;
            animation: move 25s infinite alternate;
        }
        .bg-blob.one { top: -100px; left: -100px; }
        .bg-blob.two { bottom: -150px; right: -100px; }
        
        @keyframes move {
            from { transform: translate(0, 0) scale(1); }
            to { transform: translate(100px, 100px) scale(1.2); }
        }

        .container {
            position: relative;
            z-index: 10;
            width: 90%; /* Better default for most screens */
            max-width: 440px;
            background: var(--glass-bg);
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            border: 1px solid var(--glass-border);
            border-radius: 24px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            transition: transform 0.4s cubic-bezier(0.2, 0.8, 0.2, 1), opacity 0.4s cubic-bezier(0.2, 0.8, 0.2, 1);
            overflow: hidden;
            will-change: transform, opacity;
        }

        .form-wrapper {
            display: flex;
            width: 200%;
            transition: transform 0.4s cubic-bezier(0.2, 0.8, 0.2, 1);
            will-change: transform;
        }

        .form-content {
            width: 50%;
            padding: 2.5rem;
            flex-shrink: 0;
            transition: opacity 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
        }

        .show-signup .form-wrapper { transform: translateX(-50%); }

        /* --- DASHBOARD VIEW STYLES --- */
        #dashboardView {
            display: none;
            background: #09090b;
            flex-direction: row;
        }

        /* Sidebar */
        .sidebar {
            width: 260px;
            background: #111113;
            border-right: 1px solid rgba(255, 255, 255, 0.05);
            display: flex;
            flex-direction: column;
            padding: 1.25rem;
            z-index: 100;
            height: 100vh;
            height: 100svh; /* Better mobile height */
            transition: transform 0.3s ease;
            overflow-y: auto;
            position: sticky;
            top: 0;
        }

        .sidebar-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-height: min-content;
        }

        .sidebar-footer {
            margin-top: 2rem;
            padding-top: 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.05);
            padding-bottom: 10px;
        }

        .logo-section {
            display: flex;
            flex-direction: column;
            margin-bottom: 2rem;
            padding: 0 10px;
        }

        .logo-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 4px;
        }

        .logo-icon {
            width: 28px;
            height: 28px;
            background: #3b82f6;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 0.9rem;
        }

        .logo-text {
            font-size: 1rem;
            font-weight: 600;
        }

        .logo-subtitle {
            font-size: 0.7rem;
            color: var(--text-muted);
            margin-left: 2px;
        }

        .collapse-btn {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: var(--text-main);
            padding: 6px 12px;
            border-radius: 8px;
            font-size: 0.75rem;
            width: fit-content;
            margin-top: 15px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .nav-section {
            margin-bottom: 1.5rem;
        }

        .nav-label {
            color: var(--text-muted);
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 0.75rem;
            padding-left: 10px;
            font-weight: 600;
        }

        .nav-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 12px;
            color: var(--text-muted);
            text-decoration: none;
            border-radius: 8px;
            margin-bottom: 2px;
            transition: all 0.2s ease;
            cursor: pointer;
            font-size: 0.9rem;
        }

        .nav-item-content {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .nav-item i { width: 18px; font-size: 0.9rem; }

        .nav-item:hover {
            background: rgba(255, 255, 255, 0.03);
            color: var(--text-main);
        }

        .nav-item.active {
            background: rgba(59, 130, 246, 0.1);
            color: #3b82f6;
            border: 1px solid rgba(59, 130, 246, 0.2);
        }

        .nav-arrow { font-size: 0.7rem; opacity: 0.5; }

        /* Main Content */
        .main-content {
            flex: 1;
            padding: 2rem 3rem;
            overflow-y: auto;
            position: relative;
            z-index: 5;
            height: 100vh;
        }

        .top-bar {
            display: flex;
            justify-content: flex-end;
            gap: 15px;
            margin-bottom: 2rem;
        }

        .header-icons {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-left: 10px;
        }

        .header-icon-btn {
            color: var(--text-muted);
            cursor: pointer;
            font-size: 1.1rem;
            transition: color 0.2s;
        }
        .header-icon-btn:hover { color: var(--text-main); }

        .user-profile-badge {
            display: flex;
            align-items: center;
            gap: 10px;
            background: rgba(59, 130, 246, 0.1);
            padding: 5px 12px;
            border-radius: 20px;
            cursor: pointer;
        }

        .user-avatar {
            width: 24px;
            height: 24px;
            background: #6366f1;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            font-weight: 700;
        }

        .dashboard-header {
            margin-bottom: 2rem;
        }

        .dashboard-title {
            display: flex;
            align-items: center;
            gap: 15px;
            font-size: 2.2rem;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .dashboard-subtitle {
            color: var(--text-muted);
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.95rem;
        }

        /* Generic Components */
        .form-group { margin-bottom: 1.25rem; }
        input {
            width: 100%;
            padding: 0.85rem 1rem;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            color: white;
            outline: none;
            transition: all 0.3s ease;
        }
        input:focus { border-color: var(--primary); box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.15); }

        .primary-btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 0.7rem 1.25rem; /* Smaller padding */
            border-radius: 10px; /* Slightly smaller radius */
            cursor: pointer;
            font-weight: 600;
            font-size: 0.9rem; /* Smaller font */
            transition: all 0.3s ease;
        }
        .primary-btn:hover { background: var(--primary-hover); transform: translateY(-1px); }

        #message { margin-top: 1rem; text-align: center; font-size: 0.9rem; }
        .error { color: #fda4af; }
        .success { color: #6ee7b7; }

        /* Mobile Menu Toggle */
        .menu-toggle {
            display: none;
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 1000;
            background: #3b82f6;
            color: white;
            border: none;
            padding: 10px;
            border-radius: 8px;
            cursor: pointer;
        }

        /* Hide menu toggle when auth view is active */
        #authView.active ~ .menu-toggle,
        #loadingScreen:not(.hidden) ~ .menu-toggle {
            display: none !important;
        }

        /* Center auth container better on mobile */
        @media (max-width: 480px) {
            .discord-bar {
                padding: 10px 14px !important;
                gap: 10px !important;
            }
            .discord-bar h4 {
                font-size: 0.9rem !important;
            }
            .discord-bar p {
                font-size: 0.7rem !important;
            }
            .discord-bar .primary-btn {
                 padding: 0.4rem 0.8rem !important;
                 font-size: 0.75rem !important;
             }
             .discord-icon-container {
                 width: 30px !important;
                 height: 30px !important;
             }
             .discord-bar i.fab.fa-discord {
                font-size: 16px !important;
            }

            #authView {
                display: flex;
                flex-direction: column;
                justify-content: center;
                align-items: center;
                padding: 1.5rem; /* Consistent padding */
                width: 100%;
                min-height: 100svh;
                overflow: hidden; /* Prevent random scrolling */
                background: var(--bg-dark);
            }
            .container {
                margin: 0;
                width: 100%;
                max-width: 100%; /* Force it to fill the padding width */
                border-radius: 24px;
                box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            }
            .form-content {
                padding: 2.5rem 1.5rem;
            }
        }
        @media (max-width: 1024px) {
            .sidebar {
                position: fixed;
                left: -260px;
                transition: transform 0.3s ease;
            }
            .sidebar.open {
                transform: translateX(260px);
            }
            .main-content {
                padding: 5rem 1.5rem 2rem;
            }
            .menu-toggle {
                display: block;
            }
            .dashboard-title {
                font-size: 1.8rem;
            }
        }

        @media (max-width: 480px) {
            #authView {
                padding: 10px;
                align-items: flex-start;
                padding-top: 5vh; /* Center it slightly better vertically on small screens */
                overflow-y: auto; /* Allow scrolling the whole view if form is tall */
            }
            .container {
                border-radius: 20px;
                max-width: 100%;
                margin: 0 auto;
                box-shadow: 0 10px 25px rgba(0,0,0,0.3);
            }
            .form-content {
                padding: 2rem 1.5rem;
            }
            .form-content h2 {
                font-size: 1.75rem;
                margin-bottom: 0.5rem;
            }
            .subtitle {
                margin-bottom: 1.5rem;
            }
            .form-group {
                margin-bottom: 1rem;
            }
            .dashboard-title {
                font-size: 1.5rem;
            }
            .top-bar {
                justify-content: center;
                flex-wrap: wrap;
                margin-bottom: 1rem;
            }
        }

        /* --- LOADING SCREEN --- */
        #loadingScreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--bg-dark);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            transition: opacity 0.5s ease, visibility 0.5s ease;
            padding: 20px;
        }

        .loading-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 100%;
        }

        .discord-spinner {
            position: relative;
            width: 80px;
            height: 80px;
            margin-bottom: 2.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* The fragmented "breaking" effect layers */
        .spinner-layer {
            position: absolute;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: discord-spin 1.8s cubic-bezier(0.7, 0, 0.3, 1) infinite;
        }

        /* Primary layer */
        .spinner-layer.main {
            z-index: 3;
        }

        /* Ghost/fragment layers that appear during the spin */
        .spinner-layer.ghost-1 {
            z-index: 2;
            opacity: 0.4;
            animation-delay: 0.05s;
        }

        .spinner-layer.ghost-2 {
            z-index: 1;
            opacity: 0.2;
            animation-delay: 0.1s;
        }

        .discord-spinner svg {
            width: 65px;
            height: 65px;
            fill: var(--primary);
        }

        @keyframes discord-spin {
            0% { transform: rotate(0deg); }
            50% { transform: rotate(360deg); }
            100% { transform: rotate(360deg); }
        }

        .tip-container {
            width: 100%;
            max-width: 320px;
            text-align: center;
            padding: 0 15px;
        }

        .tip-label {
            color: var(--primary);
            font-weight: 800;
            text-transform: uppercase;
            font-size: 0.8rem;
            letter-spacing: 0.12em;
            margin-bottom: 10px;
        }

        .tip-text {
            color: var(--text-main);
            font-size: 0.95rem;
            line-height: 1.5;
            opacity: 0.85;
            font-weight: 400;
        }

        @media (max-width: 480px) {
            .discord-spinner {
                width: 60px;
                height: 60px;
            }
            .discord-spinner i {
                font-size: 3.5rem;
            }
            .tip-text {
                font-size: 0.85rem;
            }
        }

        #loadingScreen.hidden {
            opacity: 0;
            visibility: hidden;
        }
    </style>
</head>
<body>

    <!-- Loading Screen -->
    <div id="loadingScreen">
        <div class="loading-container">
            <div class="discord-spinner">
                <!-- Main Layer -->
                <div class="spinner-layer main">
                    <svg viewBox="0 0 127.14 96.36">
                        <path d="M107.7,8.07A105.15,105.15,0,0,0,81.47,0a72.06,72.06,0,0,0-3.36,6.83A97.68,97.68,0,0,0,49,6.83,72.06,72.06,0,0,0,45.64,0,105.89,105.89,0,0,0,19.39,8.09C2.71,32.65-1.82,56.6.39,80.21a105.73,105.73,0,0,0,32.17,16.15,77.7,77.7,0,0,0,6.89-11.11,68.42,68.42,0,0,1-10.85-5.18c.91-.66,1.8-1.34,2.66-2a75.57,75.57,0,0,0,64.32,0c.87.71,1.76,1.39,2.66,2a68.68,68.68,0,0,1-10.87,5.19,77,77,0,0,0,6.89,11.1,105.25,105.25,0,0,0,32.19-16.14c2.64-27.38-4.52-51.06-19.1-72.13ZM42.45,65.69C36.18,65.69,31,60,31,53s5.12-12.67,11.41-12.67S54,46,53.86,53,48.74,65.69,42.45,65.69Zm42.24,0C78.41,65.69,73.25,60,73.25,53s5.12-12.67,11.41-12.67S96.08,46,95.94,53,90.82,65.69,84.69,65.69Z"/>
                    </svg>
                </div>
                <!-- Ghost Layers for "breaking" effect -->
                <div class="spinner-layer ghost-1">
                    <svg viewBox="0 0 127.14 96.36">
                        <path d="M107.7,8.07A105.15,105.15,0,0,0,81.47,0a72.06,72.06,0,0,0-3.36,6.83A97.68,97.68,0,0,0,49,6.83,72.06,72.06,0,0,0,45.64,0,105.89,105.89,0,0,0,19.39,8.09C2.71,32.65-1.82,56.6.39,80.21a105.73,105.73,0,0,0,32.17,16.15,77.7,77.7,0,0,0,6.89-11.11,68.42,68.42,0,0,1-10.85-5.18c.91-.66,1.8-1.34,2.66-2a75.57,75.57,0,0,0,64.32,0c.87.71,1.76,1.39,2.66,2a68.68,68.68,0,0,1-10.87,5.19,77,77,0,0,0,6.89,11.1,105.25,105.25,0,0,0,32.19-16.14c2.64-27.38-4.52-51.06-19.1-72.13ZM42.45,65.69C36.18,65.69,31,60,31,53s5.12-12.67,11.41-12.67S54,46,53.86,53,48.74,65.69,42.45,65.69Zm42.24,0C78.41,65.69,73.25,60,73.25,53s5.12-12.67,11.41-12.67S96.08,46,95.94,53,90.82,65.69,84.69,65.69Z"/>
                    </svg>
                </div>
                <div class="spinner-layer ghost-2">
                    <svg viewBox="0 0 127.14 96.36">
                        <path d="M107.7,8.07A105.15,105.15,0,0,0,81.47,0a72.06,72.06,0,0,0-3.36,6.83A97.68,97.68,0,0,0,49,6.83,72.06,72.06,0,0,0,45.64,0,105.89,105.89,0,0,0,19.39,8.09C2.71,32.65-1.82,56.6.39,80.21a105.73,105.73,0,0,0,32.17,16.15,77.7,77.7,0,0,0,6.89-11.11,68.42,68.42,0,0,1-10.85-5.18c.91-.66,1.8-1.34,2.66-2a75.57,75.57,0,0,0,64.32,0c.87.71,1.76,1.39,2.66,2a68.68,68.68,0,0,1-10.87,5.19,77,77,0,0,0,6.89,11.1,105.25,105.25,0,0,0,32.19-16.14c2.64-27.38-4.52-51.06-19.1-72.13ZM42.45,65.69C36.18,65.69,31,60,31,53s5.12-12.67,11.41-12.67S54,46,53.86,53,48.74,65.69,42.45,65.69Zm42.24,0C78.41,65.69,73.25,60,73.25,53s5.12-12.67,11.41-12.67S96.08,46,95.94,53,90.82,65.69,84.69,65.69Z"/>
                    </svg>
                </div>
            </div>
            <div class="tip-container">
                <div class="tip-label">Did you know</div>
                <div class="tip-text" id="tipText">Loading awesome things...</div>
            </div>
        </div>
    </div>

    <!-- Auth View -->
    <div id="authView" class="view active">
        <div class="bg-blob one"></div>
        <div class="bg-blob two"></div>
        <div class="container" id="mainContainer">
            <div class="form-wrapper">
                <div class="form-content" id="loginView">
                    <h2>Welcome Back</h2>
                    <p class="subtitle">Enter your details to sign in</p>
                    <div class="form-group">
                        <label>Email Address</label>
                        <input type="email" id="loginEmail" placeholder="name@example.com">
                    </div>
                    <div class="form-group">
                        <label>Password</label>
                        <input type="password" id="loginPassword" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
                    </div>
                    <button id="loginBtn" class="primary-btn" style="width: 100%;">Sign In</button>
                    <p style="text-align: center; margin-top: 1.5rem; font-size: 0.9rem; color: var(--text-muted);">
                        Don't have an account? <span id="toSignup" style="color: #3b82f6; cursor: pointer; font-weight: 600;">Create one</span>
                    </p>
                </div>
                <div class="form-content" id="signupView">
                    <h2>Create Account</h2>
                    <p class="subtitle">Join JaVibe today</p>
                    <div style="display: flex; gap: 12px;">
                        <div class="form-group">
                            <label>First Name</label>
                            <input type="text" id="firstName" placeholder="John">
                        </div>
                        <div class="form-group">
                            <label>Last Name</label>
                            <input type="text" id="lastName" placeholder="Doe">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Email Address</label>
                        <input type="email" id="signupEmail" placeholder="name@example.com">
                    </div>
                    <div class="form-group">
                        <label>Password</label>
                        <input type="password" id="signupPassword" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
                    </div>
                    <div class="form-group">
                        <label>Confirm Password</label>
                        <input type="password" id="confirmPassword" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
                    </div>
                    <button id="signupBtn" class="primary-btn" style="width: 100%;">Create Account</button>
                    <p style="text-align: center; margin-top: 1.5rem; font-size: 0.9rem; color: var(--text-muted);">
                        Already have an account? <span id="toLogin" style="color: #3b82f6; cursor: pointer; font-weight: 600;">Sign in</span>
                    </p>
                </div>
            </div>
            <div id="message"></div>
        </div>
    </div>

    <!-- Mobile Menu Toggle -->
    <button class="menu-toggle" id="menuToggle">
        <i class="fas fa-bars"></i>
    </button>

    <!-- Dashboard View -->
    <div id="dashboardView" class="view">
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-content">
                <div class="logo-section">
                    <div class="logo-header">
                        <div class="logo-icon"><i class="fas fa-cube"></i></div>
                        <span class="logo-text">JaVibe</span>
                    </div>
                    <span class="logo-subtitle">Music's come in a great hands.</span>
                    <button class="collapse-btn"><i class="fas fa-angles-left"></i> Collapse</button>
                </div>

                <div class="nav-section">
                    <p class="nav-label">Main</p>
                    <div class="nav-item active" onclick="showSection('home')">
                        <div class="nav-item-content"><i class="fas fa-home"></i> Home</div>
                    </div>
                    <div class="nav-item" onclick="showSection('dashboard')">
                        <div class="nav-item-content"><i class="fab fa-spotify"></i> Spotify</div>
                    </div>
                </div>

                <div class="nav-section">
                    <p class="nav-label">Connect</p>
                    <div id="spotifyConnectBtn" class="nav-item">
                        <div class="nav-item-content">
                            <i class="fab fa-spotify" style="color: #1DB954;"></i>
                            <span>Connect Spotify</span>
                        </div>
                    </div>
                    <div id="spotifyUser" class="nav-item" style="display: none; pointer-events: none;">
                        <div class="nav-item-content">
                            <img id="spotifyUserImg" src="" style="width: 20px; height: 20px; border-radius: 50%; display: none;">
                            <span id="spotifyUserName" style="color: #1DB954; font-weight: 600;">Connected</span>
                        </div>
                    </div>
                </div>

                <div class="nav-section">
                    <p class="nav-label">Account</p>
                    <div class="nav-item" onclick="showSection('profile')">
                        <div class="nav-item-content"><i class="fas fa-user"></i> Profile</div>
                    </div>
                    <div class="nav-item" onclick="showSection('settings')">
                        <div class="nav-item-content"><i class="fas fa-cog"></i> Settings</div>
                    </div>
                </div>

                <div class="nav-section">
                    <p class="nav-label">System</p>
                    <div class="nav-item" onclick="handleGenericAction('Node Status')">
                        <div class="nav-item-content"><i class="fas fa-microchip"></i> Node Status</div>
                    </div>
                </div>
            </div>

            <div class="sidebar-footer">
                <div class="nav-item" onclick="handleLogout()">
                    <div class="nav-item-content"><i class="fas fa-sign-out-alt"></i> Sign Out</div>
                </div>
                <p style="font-size: 0.65rem; color: var(--text-muted); margin-top: 10px; padding-left: 10px;">JaMusic Research and Coding Corp.</p>
            </div>
        </aside>

        <main class="main-content">
            <div class="top-bar">
                <div class="header-icons">
                    <i class="fas fa-globe header-icon-btn" onclick="window.open('https://javibe.vercel.app', '_blank')"></i>
                    <div class="user-profile-badge" onclick="showSection('profile')">
                        <div class="user-avatar" id="avatarLetter">U</div>
                        <span style="font-size: 0.85rem;" id="headerUsername">User</span>
                    </div>
                </div>
            </div>

            <div id="homeSection">
                <div class="dashboard-header">
                    <h1 class="dashboard-title"><i class="fas fa-home" style="color: #3b82f6; font-size: 1.8rem;"></i> Home ðŸŽ„</h1>
                    <p class="dashboard-subtitle">âœ¨ Welcome to your personal space.</p>
                </div>
                <!-- ... existing content ... -->
            </div>

            <div id="dashboardSection" style="display: none;">
                <div class="dashboard-header">
                    <h1 class="dashboard-title"><i class="fab fa-spotify" style="color: #1DB954; font-size: 1.8rem;"></i> Spotify Search</h1>
                    <p class="dashboard-subtitle">ðŸŽµ Explore millions of tracks and albums from Spotify.</p>
                </div>

                <div class="search-container" style="margin-bottom: 2rem;">
                    <div style="position: relative; display: flex; gap: 10px;">
                        <input type="text" id="spotifySearchInput" placeholder="Search for tracks, artists, or albums..." style="padding-right: 45px;">
                        <button id="spotifySearchBtn" class="primary-btn" style="white-space: nowrap;">Search</button>
                    </div>
                </div>

                <div id="spotifyResults" class="results-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 20px;">
                    <!-- Results will appear here -->
                    <div style="grid-column: 1/-1; text-align: center; padding: 3rem; color: var(--text-muted);">
                        <i class="fab fa-spotify" style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.2;"></i>
                        <p>Connect Spotify and search for something to see results</p>
                    </div>
                </div>

                <!-- Music Player Bar (Spotify-first) -->
                <div id="musicPlayerBar" style="display: none; position: fixed; bottom: 0; left: 0; right: 0; background: rgba(10, 10, 12, 0.98); backdrop-filter: blur(15px); border-top: 1px solid rgba(255, 255, 255, 0.1); z-index: 1000; flex-direction: column;">
                    <!-- Spotify Embed Container -->
                    <div id="youtube-player-container" style="width: 100%; height: 80px; overflow: hidden; background: #000;"></div>
                    
                    <!-- Metadata & Controls (Optional fallback) -->
                    <div id="playerMetadata" style="display: none; padding: 12px 24px; align-items: center; justify-content: space-between;">
                        <div style="display: flex; align-items: center; gap: 15px; flex: 1; min-width: 0;">
                            <img id="playerThumb" src="" style="width: 40px; height: 40px; border-radius: 8px; object-fit: cover;">
                            <div style="min-width: 0;">
                                <h4 id="playerTitle" style="margin: 0; font-size: 0.85rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; color: white;"></h4>
                                <p id="playerArtist" style="margin: 0; font-size: 0.7rem; color: var(--text-muted); white-space: nowrap; overflow: hidden; text-overflow: ellipsis;"></p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

                <div class="discord-bar" style="background: #111113; border: 1px solid rgba(255, 255, 255, 0.05); color: white; padding: 12px 16px; border-radius: 16px; display: flex; justify-content: space-between; align-items: center; gap: 12px; margin-bottom: 2rem;">
                    <div style="display: flex; align-items: center; gap: 12px; min-width: 0;">
                        <div class="discord-icon-container" style="background: #5865f2; width: 34px; height: 34px; border-radius: 10px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                            <i class="fab fa-discord" style="font-size: 18px;"></i>
                        </div>
                        <div style="min-width: 0;">
                            <h4 style="margin: 0; font-size: 1rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">Join our Discord!</h4>
                            <p style="margin: 0; color: var(--text-muted); font-size: 0.75rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">Updates & support.</p>
                        </div>
                    </div>
                    <a href="https://discord.gg/QYTgmVq96v" target="_blank" class="primary-btn" style="text-decoration: none; padding: 0.5rem 1rem; font-size: 0.8rem; flex-shrink: 0; white-space: nowrap;">Join Server</a>
                </div>

                <div class="welcome-card" style="background: #111113; border: 1px solid rgba(255, 255, 255, 0.05); padding: 2.5rem; border-radius: 20px; margin-bottom: 2rem;">
                    <h2 style="margin-bottom: 1rem; font-size: 1.5rem;">Welcome to JaVibe, <span id="welcomeUser">User</span>! ðŸ‘‹</h2>
                    <p style="color: var(--text-muted); font-size: 0.95rem; line-height: 1.6; margin-bottom: 1.5rem; max-width: 800px;">
                        Ready to start your day with some freshly baked songs? JaVibe offers the best free 24/7 musics because we offer performance and the ability of not having to keep your phone on all-day! We do not take battery consumption.
                    </p>
                    <p style="color: var(--text-muted); font-size: 0.95rem; line-height: 1.6; margin-bottom: 1.5rem;">
                        We recommend you to join our Discord Server if you're looking to reach out for support! Our community is pretty welcoming and will help you get started in no time.
                    </p>
                    
                    <div class="action-links" style="display: flex; gap: 25px; flex-wrap: wrap;">
                        <a href="https://discord.gg/QYTgmVq96v" target="_blank" class="action-link" style="color: #3b82f6; text-decoration: none; font-size: 0.9rem; display: flex; align-items: center; gap: 8px; font-weight: 600;">
                            <i class="fab fa-discord"></i> Join our Discord Server!
                        </a>
                        <a href="#" class="action-link" onclick="handleUsernameChange()" style="color: var(--text-main); text-decoration: none; font-size: 0.9rem; display: flex; align-items: center; gap: 8px; opacity: 0.8;">
                            Change your username
                        </a>
                    </div>
                </div>
            </div>

            <div id="profileSection" style="display: none;">
                <h2>User Profile</h2>
                <div class="welcome-card" style="margin-top: 1.5rem;">
                    <p><strong>Email:</strong> <span id="profileEmail">...</span></p>
                    <p><strong>Display Name:</strong> <span id="profileName">...</span></p>
                    <p><strong>Account Status:</strong> Verified</p>
                </div>
            </div>

            <div id="settingsSection" style="display: none;">
                <h2>Account Settings</h2>
                <div class="welcome-card" style="margin-top: 1.5rem;">
                    <p>Settings functionality is currently in development.</p>
                </div>
            </div>
        </main>
    </div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { 
        getAuth, 
        createUserWithEmailAndPassword, 
        signInWithEmailAndPassword, 
        sendEmailVerification,
        updateProfile,
        onAuthStateChanged,
        signOut
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    // --- KEEP FIREBASE CONFIG ---
    const firebaseConfig = {
          apiKey: "AIzaSyApKLZIjUZSQnKJCngvp0KZPYJf3zBNaCc",
  authDomain: "jamusic-v2.firebaseapp.com",
  projectId: "jamusic-v2",
  storageBucket: "jamusic-v2.firebasestorage.app",
  messagingSenderId: "765002295434",
  appId: "1:765002295434:web:a4c9ba98c68dbcd84f2573"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);

    // --- LOADING SCREEN LOGIC ---
    const tips = [
        "JaVibe is designed for speed and simplicity.",
        "You can upgrade to Premium for exclusive features.",
        "Our Discord community is always here to help!",
        "Music sounds better when shared with friends.",
        "You can change your username in the settings.",
        "Node status shows you the real-time health of our systems.",
        "JaVibe was built with passion for developers.",
        "Check out our global website for more JaVibe updates."
    ];

    function initLoading() {
        const loadingScreen = document.getElementById('loadingScreen');
        const tipText = document.getElementById('tipText');
        
        // Pick a random tip
        const randomTip = tips[Math.floor(Math.random() * tips.length)];
        if (tipText) tipText.textContent = randomTip;

        // Hide loading screen after 3 seconds
        setTimeout(() => {
            if (loadingScreen) {
                loadingScreen.classList.add('hidden');
            }
        }, 3000);
    }

    // Initialize loading screen
    initLoading();

    // --- SNOWFLAKE LOGIC ---
    function createSnowflake() {
        const snowflake = document.createElement('div');
        snowflake.classList.add('snowflake');
        snowflake.innerHTML = 'â€¢';
        snowflake.style.left = Math.random() * 100 + 'vw';
        snowflake.style.animationDuration = Math.random() * 3 + 2 + 's';
        snowflake.style.opacity = Math.random();
        snowflake.style.fontSize = Math.random() * 10 + 10 + 'px';
        
        document.body.appendChild(snowflake);
        
        setTimeout(() => {
            snowflake.remove();
        }, 5000);
    }
    setInterval(createSnowflake, 100);

    // --- VIEW MANAGEMENT ---
    const authView = document.getElementById('authView');
    const dashboardView = document.getElementById('dashboardView');
    const welcomeUser = document.getElementById('welcomeUser');
    const headerUsername = document.getElementById('headerUsername');
    const avatarLetter = document.getElementById('avatarLetter');
    const sidebar = document.getElementById('sidebar');
    const menuToggle = document.getElementById('menuToggle');

    // Mobile menu toggle
    if (menuToggle && sidebar) {
        menuToggle.onclick = () => {
            sidebar.classList.toggle('open');
            const icon = menuToggle.querySelector('i');
            if (sidebar.classList.contains('open')) {
                icon.classList.replace('fa-bars', 'fa-times');
            } else {
                icon.classList.replace('fa-times', 'fa-bars');
            }
        };
    }

    // Close sidebar on nav item click (mobile)
    document.querySelectorAll('.nav-item').forEach(item => {
        item.addEventListener('click', () => {
            if (window.innerWidth <= 1024 && sidebar.classList.contains('open')) {
                sidebar.classList.remove('open');
                menuToggle.querySelector('i').classList.replace('fa-times', 'fa-bars');
            }
        });
    });

    // Global toggle function
    window.toggleView = (showSignup) => {
        const container = document.getElementById('mainContainer');
        if (showSignup) {
            container.classList.add('show-signup');
        } else {
            container.classList.remove('show-signup');
        }
    };

    onAuthStateChanged(auth, (user) => {
        if (user) {
            if (user.emailVerified) {
                // Fully verified, show dashboard
                authView.classList.remove('active');
                setTimeout(() => {
                    authView.style.display = 'none';
                    dashboardView.style.display = 'flex';
                    setTimeout(() => dashboardView.classList.add('active'), 50);
                    
                    const displayName = user.displayName || user.email.split('@')[0];
                    welcomeUser.textContent = displayName;
                    headerUsername.textContent = displayName;
                    avatarLetter.textContent = displayName.charAt(0).toUpperCase();
                    
                    document.getElementById('profileEmail').textContent = user.email;
                    document.getElementById('profileName').textContent = user.displayName || 'N/A';
                }, 400);
            } else {
                // Logged in but not verified
                authView.style.display = 'flex';
                dashboardView.style.display = 'none';
                authView.classList.add('active');
                showMessage("Please verify your email! Check your inbox.", true);
                
                const msgDiv = document.getElementById('message');
                if (!document.getElementById('refreshVerifyBtn')) {
                    const btn = document.createElement('button');
                    btn.id = 'refreshVerifyBtn';
                    btn.textContent = "I've Verified (Refresh)";
                    btn.className = 'primary-btn';
                    btn.style.marginTop = '10px';
                    btn.style.width = '100%';
                    btn.onclick = () => location.reload();
                    msgDiv.appendChild(btn);
                }
                console.log("JaVibe: User verification pending.");
            }
        } else {
            // Logged out, show auth
            dashboardView.classList.remove('active');
            setTimeout(() => {
                dashboardView.style.display = 'none';
                authView.style.display = 'flex';
                setTimeout(() => authView.classList.add('active'), 50);
                // Re-initialize buttons just in case
                if (typeof initAuthButtons === 'function') initAuthButtons();
            }, 400);
        }
    });

    // Event listeners for switching
    document.getElementById('toSignup').onclick = () => toggleView(true);
    document.getElementById('toLogin').onclick = () => toggleView(false);

    window.showSection = (section) => {
        document.getElementById('homeSection').style.display = 'none';
        document.getElementById('dashboardSection').style.display = 'none';
        document.getElementById('profileSection').style.display = 'none';
        document.getElementById('settingsSection').style.display = 'none';
        
        const sectionId = `${section}Section`;
        const targetSection = document.getElementById(sectionId);
        if (targetSection) targetSection.style.display = 'block';
        
        // Update nav active state
        document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
        const navItems = document.querySelectorAll('.nav-item');
        navItems.forEach(item => {
            if (item.getAttribute('onclick')?.includes(`'${section}'`)) {
                item.classList.add('active');
            }
        });

        // Update title and icon if dashboard section
        if (section === 'dashboard') {
            // Dashboard has its own title structure in the HTML
        } else {
            // For other sections, we could update the top title if needed
        }
    };

    window.handleGenericAction = (action) => {
        alert(`${action} functionality coming soon! This button is now linked.`);
    };

    // --- DASHBOARD BUTTON ACTIONS ---
    window.handleLogout = async () => {
        try {
            await signOut(auth);
            // Clear any local data if needed
            localStorage.removeItem('spotify_access_token');
            // Reload to ensure a clean state
            window.location.reload();
        } catch (error) {
            console.error("Logout Error:", error);
            alert("Error signing out. Please try again.");
        }
    };
    window.handlePremium = () => alert("Redirecting to Premium Upgrade page...");
    window.handleUsernameChange = () => {
        const newName = prompt("Enter your new display name:");
        if (newName) {
            updateProfile(auth.currentUser, { displayName: newName })
                .then(() => {
                    alert("Username updated!");
                    location.reload();
                })
                .catch(err => alert(err.message));
        }
    };

    // --- PLAYER STATE ---
    let player; // YouTube Player
    let audioPlayer = new Audio(); // Spotify/Audio Player
    let isPlaying = false;
    let progressInterval;

    function startProgressLoop() {
        if (progressInterval) clearInterval(progressInterval);
        progressInterval = setInterval(() => {
            if (audioPlayer.src && !audioPlayer.paused) {
                updateProgressBar(audioPlayer.currentTime, audioPlayer.duration);
            } else if (player && player.getCurrentTime && isPlaying) {
                updateProgressBar(player.getCurrentTime(), player.getDuration());
            }
        }, 500);
    }

    function stopProgressLoop() {
        if (progressInterval) {
            clearInterval(progressInterval);
            progressInterval = null;
        }
    }

    function updateProgressBar(current, total) {
        const progressBar = document.getElementById('progressBar');
        const currentTimeEl = document.getElementById('currentTime');
        const durationEl = document.getElementById('duration');
        
        if (total > 0) {
            const pct = (current / total) * 100;
            progressBar.style.width = `${pct}%`;
            
            currentTimeEl.textContent = formatTime(current);
            durationEl.textContent = formatTime(total);
        }
    }

    function formatTime(seconds) {
        if (isNaN(seconds)) return "0:00";
        const mins = Math.floor(seconds / 60);
        const secs = Math.floor(seconds % 60);
        return `${mins}:${secs.toString().padStart(2, '0')}`;
    }

    // --- DESKTOP SPOOFING FOR MOBILE ---
    function forceDesktopMode() {
        if (window.innerWidth < 1024) {
            const viewport = document.querySelector('meta[name="viewport"]');
            if (viewport) {
                viewport.setAttribute('content', 'width=1024');
            }
            
            const scale = window.screen.width / 1024;
            document.documentElement.style.width = '1024px';
            document.documentElement.style.overflowX = 'hidden';
            // We don't use transform on body as it breaks fixed positioning, 
            // just forcing the width often tricks the SDK initialization.
        }
    }
    forceDesktopMode();

    // --- SPOTIFY INTEGRATION (PKCE FLOW) ---
    let SPOTIFY_CLIENT_ID = localStorage.getItem('spotify_client_id') || "55afa568f2f74d2f8235de04285fa817";
    
    // REDIRECT_URI fix for GitHub Pages
    const REDIRECT_URI = (window.location.hostname === 'javibe-dev.github.io')
        ? "https://javibe-dev.github.io/-/"
        : (window.location.protocol === 'file:') 
            ? "http://127.0.0.1:5500/index.html" 
            : window.location.origin + window.location.pathname;

    const SCOPES = "user-read-private user-read-email user-library-read streaming user-modify-playback-state user-read-playback-state";
    
    let spotifyAccessToken = localStorage.getItem('spotify_access_token');
    let spotifyPlayer = null;
    let spotifyDeviceId = null;

    // Initialize Spotify Web Playback SDK
    window.onSpotifyWebPlaybackSDKReady = () => {
        if (spotifyAccessToken) {
            initSpotifyPlayer();
        }
    };

    function initSpotifyPlayer() {
        if (spotifyPlayer) return;

        spotifyPlayer = new Spotify.Player({
            name: 'JaVibe Player',
            getOAuthToken: cb => { cb(spotifyAccessToken); },
            volume: 0.5
        });

        // Error handling
        spotifyPlayer.addListener('initialization_error', ({ message }) => { console.error(message); });
        spotifyPlayer.addListener('authentication_error', ({ message }) => { console.error(message); handleLogout(); });
        spotifyPlayer.addListener('account_error', ({ message }) => { console.error(message); });
        spotifyPlayer.addListener('playback_error', ({ message }) => { console.error(message); });

        // Playback status updates
        spotifyPlayer.addListener('player_state_changed', state => {
            if (!state) return;
            // Update UI if needed based on state
        });

        // Ready
        spotifyPlayer.addListener('ready', ({ device_id }) => {
            console.log('Ready with Device ID', device_id);
            spotifyDeviceId = device_id;
        });

        // Not Ready
        spotifyPlayer.addListener('not_ready', ({ device_id }) => {
            console.log('Device ID has gone offline', device_id);
        });

        // Connect to the player!
        spotifyPlayer.connect();
    }

    async function getSpotifyDevices() {
        if (!spotifyAccessToken) return [];
        try {
            const response = await fetch('https://api.spotify.com/v1/me/player/devices', {
                headers: { 'Authorization': `Bearer ${spotifyAccessToken}` }
            });
            const data = await response.json();
            return data.devices || [];
        } catch (err) {
            console.error("Error fetching devices:", err);
            return [];
        }
    }

    async function transferSpotifyPlayback(deviceId) {
        try {
            await fetch('https://api.spotify.com/v1/me/player', {
                method: 'PUT',
                headers: {
                    'Authorization': `Bearer ${spotifyAccessToken}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ device_ids: [deviceId], play: true })
            });
        } catch (err) {
            console.error("Transfer Error:", err);
        }
    }
    
    const spotifySearchInput = document.getElementById('spotifySearchInput');
    const spotifySearchBtn = document.getElementById('spotifySearchBtn');
    const spotifyResults = document.getElementById('spotifyResults');
    const spotifyConnectBtn = document.getElementById('spotifyConnectBtn');
    const spotifyUser = document.getElementById('spotifyUser');
    const spotifyUserImg = document.getElementById('spotifyUserImg');
    const spotifyUserName = document.getElementById('spotifyUserName');

    // PKCE Helpers
    const generateRandomString = (length) => {
        const possible = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
        const values = crypto.getRandomValues(new Uint8Array(length));
        return values.reduce((acc, x) => acc + possible[x % possible.length], "");
    };

    const sha256 = async (plain) => {
        const encoder = new TextEncoder();
        const data = encoder.encode(plain);
        return window.crypto.subtle.digest('SHA-256', data);
    };

    const base64encode = (input) => {
        return btoa(String.fromCharCode(...new Uint8Array(input)))
            .replace(/=/g, '')
            .replace(/\+/g, '-')
            .replace(/\//g, '_');
    };

    // Function to update Client ID
    function setSpotifyClientId() {
        const newId = prompt("Please enter your Spotify Client ID:", SPOTIFY_CLIENT_ID);
        if (newId) {
            SPOTIFY_CLIENT_ID = newId.trim();
            localStorage.setItem('spotify_client_id', SPOTIFY_CLIENT_ID);
            alert("Spotify Client ID updated! Please try connecting again.");
        }
    }

    // Handle Spotify Auth Redirect
    async function checkSpotifyAuth() {
        const urlParams = new URLSearchParams(window.location.search);
        const code = urlParams.get('code');
        const error = urlParams.get('error');

        if (error) {
            alert(`Spotify Error: ${error}\n\nMake sure your Client ID is correct and your Redirect URI in Spotify Dashboard is exactly: ${REDIRECT_URI}`);
            return;
        }

        if (code) {
            // Exchange code for token
            const codeVerifier = localStorage.getItem('spotify_code_verifier');
            
            try {
                const response = await fetch('https://accounts.spotify.com/api/token', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: new URLSearchParams({
                        client_id: SPOTIFY_CLIENT_ID,
                        grant_type: 'authorization_code',
                        code: code,
                        redirect_uri: REDIRECT_URI,
                        code_verifier: codeVerifier,
                    }),
                });

                const data = await response.json();
                if (data.access_token) {
                    spotifyAccessToken = data.access_token;
                    localStorage.setItem('spotify_access_token', spotifyAccessToken);
                    // Clear the URL
                    window.history.replaceState({}, document.title, window.location.pathname);
                    updateSpotifyUI(true);
                    initSpotifyPlayer();
                } else {
                    console.error("Token exchange failed:", data);
                }
            } catch (e) {
                console.error("Auth Error:", e);
            }
        } else if (spotifyAccessToken) {
            updateSpotifyUI(true);
        }
    }

    async function updateSpotifyUI(isConnected) {
        if (isConnected) {
            spotifyConnectBtn.style.display = 'none';
            spotifyUser.style.display = 'flex';
            
            try {
                const response = await fetch('https://api.spotify.com/v1/me', {
                    headers: { 'Authorization': `Bearer ${spotifyAccessToken}` }
                });
                if (response.ok) {
                    const data = await response.json();
                    spotifyUserName.textContent = data.display_name;
                    if (data.images && data.images.length > 0) {
                        spotifyUserImg.src = data.images[0].url;
                        spotifyUserImg.style.display = 'block';
                    }
                } else if (response.status === 401) {
                    handleSpotifyLogout();
                }
            } catch (e) {
                console.error("Spotify Profile Error:", e);
            }
        } else {
            spotifyConnectBtn.style.display = 'flex';
            spotifyUser.style.display = 'none';
        }
    }

    async function handleSpotifyLogin() {
        if (window.location.protocol === 'file:') {
            alert("Spotify does not support 'file://' URLs.\n\nPlease use http://127.0.0.1:5500/index.html (or similar).");
            return;
        }

        const codeVerifier = generateRandomString(64);
        const hashed = await sha256(codeVerifier);
        const codeChallenge = base64encode(hashed);

        localStorage.setItem('spotify_code_verifier', codeVerifier);

        const params = new URLSearchParams({
            response_type: 'code',
            client_id: SPOTIFY_CLIENT_ID,
            scope: SCOPES,
            code_challenge_method: 'S256',
            code_challenge: codeChallenge,
            redirect_uri: REDIRECT_URI,
        });

        window.location.href = `https://accounts.spotify.com/authorize?${params.toString()}`;
    }

    function handleSpotifyLogout() {
        localStorage.removeItem('spotify_access_token');
        spotifyAccessToken = null;
        updateSpotifyUI(false);
    }

    spotifyConnectBtn.onclick = handleSpotifyLogin;
    checkSpotifyAuth();

    async function searchSpotify(query) {
        if (!query) return;
        if (!spotifyAccessToken) {
            alert("Please connect Spotify first!");
            return;
        }
        
        spotifySearchBtn.disabled = true;
        spotifySearchBtn.textContent = "Searching...";
        spotifyResults.innerHTML = `
            <div style="grid-column: 1/-1; text-align: center; padding: 3rem;">
                <div style="border: 3px solid rgba(255,255,255,0.1); border-top: 3px solid #1DB954; width: 30px; height: 30px; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 1rem;"></div>
                <p>Searching Spotify...</p>
            </div>
        `;

        try {
            const response = await fetch(`https://api.spotify.com/v1/search?q=${encodeURIComponent(query)}&type=track&limit=20`, {
                headers: { 'Authorization': `Bearer ${spotifyAccessToken}` }
            });
            
            if (!response.ok) {
                if (response.status === 401) {
                    handleSpotifyLogout();
                    throw new Error("Session expired. Please reconnect Spotify.");
                }
                throw new Error("Spotify Search Failed");
            }
            
            const data = await response.json();
            const tracks = data.tracks.items;
            
            if (tracks.length === 0) {
                spotifyResults.innerHTML = '<div style="grid-column: 1/-1; text-align: center; padding: 3rem; color: var(--text-muted);">No tracks found.</div>';
            } else {
                spotifyResults.innerHTML = '';
                tracks.forEach(track => {
                    const card = document.createElement('div');
                    card.style.cssText = `
                        background: rgba(255, 255, 255, 0.03);
                        border: 1px solid rgba(255, 255, 255, 0.05);
                        border-radius: 12px;
                        overflow: hidden;
                        transition: all 0.2s ease;
                        cursor: pointer;
                    `;
                    card.onmouseover = () => {
                        card.style.transform = 'translateY(-5px)';
                        card.style.background = 'rgba(255, 255, 255, 0.06)';
                    };
                    card.onmouseout = () => {
                        card.style.transform = 'translateY(0)';
                        card.style.background = 'rgba(255, 255, 255, 0.03)';
                    };
                    
                    const thumb = track.album.images[0]?.url || '';
                    const artist = track.artists.map(a => a.name).join(', ');
                    
                    card.onclick = () => playSpotifyTrack(track.id, track.name, artist, thumb, track.preview_url);

                    card.innerHTML = `
                        <div style="position: relative; aspect-ratio: 1/1; overflow: hidden;">
                            <img src="${thumb}" style="width: 100%; height: 100%; object-fit: cover;">
                            <div style="position: absolute; bottom: 8px; right: 8px; background: rgba(29, 185, 84, 0.9); padding: 2px 6px; border-radius: 4px; font-size: 0.7rem; color: white;">Spotify</div>
                        </div>
                        <div style="padding: 12px;">
                            <h5 style="margin: 0 0 4px; font-size: 0.9rem; line-height: 1.4; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; color: white;">${track.name}</h5>
                            <p style="margin: 0; font-size: 0.75rem; color: var(--text-muted);">${artist}</p>
                        </div>
                    `;
                    spotifyResults.appendChild(card);
                });
            }
        } catch (error) {
            spotifyResults.innerHTML = `
                <div style="grid-column: 1/-1; text-align: center; padding: 3rem; color: #fda4af;">
                    <i class="fas fa-exclamation-circle" style="font-size: 2rem; margin-bottom: 1rem;"></i>
                    <p>To get full tracks on mobile, please reconnect Spotify to grant playback permissions.</p>
                    <button onclick="handleSpotifyLogin()" class="primary-btn" style="margin-top: 1rem; width: auto; padding: 8px 20px;">Reconnect Spotify for Full Tracks</button>
                </div>
            `;
        } finally {
            spotifySearchBtn.disabled = false;
            spotifySearchBtn.textContent = "Search";
        }
    }

    spotifySearchBtn.onclick = () => searchSpotify(spotifySearchInput.value);
    spotifySearchInput.onkeypress = (e) => { if (e.key === 'Enter') searchSpotify(spotifySearchInput.value); };

    async function playSpotifyTrack(trackId, title, artist, thumb, previewUrl) {
        // Show player bar
        const playerBar = document.getElementById('musicPlayerBar');
        playerBar.style.display = 'flex';
        
        document.getElementById('playerTitle').textContent = title;
        document.getElementById('playerArtist').textContent = artist;
        document.getElementById('playerThumb').src = thumb;
        
        if (audioPlayer) {
            audioPlayer.pause();
            audioPlayer.src = '';
            stopProgressLoop();
        }

        const playOnDevice = async (deviceId) => {
            return fetch(`https://api.spotify.com/v1/me/player/play${deviceId ? `?device_id=${deviceId}` : ''}`, {
                method: 'PUT',
                headers: {
                    'Authorization': `Bearer ${spotifyAccessToken}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ uris: [`spotify:track:${trackId}`] })
            });
        };

        // 1. Try JaVibe Player (SDK - FORCED ON ALL DEVICES)
        if (spotifyAccessToken && spotifyDeviceId) {
            const res = await playOnDevice(spotifyDeviceId);
            if (res.ok) {
                console.log("Playing on JaVibe Player");
                return finalizePlayback(trackId, true);
            }
        }

        // 2. FORCE-ACTIVE MOBILE SYNC
        if (spotifyAccessToken) {
            const devices = await getSpotifyDevices();
            // In Desktop-Spoof mode, we aggressively target ANY device found
            const targetDevice = devices.find(d => d.is_active) || 
                               devices.find(d => d.type.toLowerCase() === 'smartphone') || 
                               devices[0];
            
            if (targetDevice) {
                console.log(`Forcing sync to ${targetDevice.name}`);
                await transferSpotifyPlayback(targetDevice.id);
                
                const res = await playOnDevice(targetDevice.id);
                if (res.ok) {
                    return finalizePlayback(trackId, true);
                }
            }
        }

        // 3. ABSOLUTE LAST RESORT: Embed (30s preview)
        // This only happens if NO Spotify devices are found at all
        const playerContainer = document.getElementById('youtube-player-container');
        playerContainer.innerHTML = `<iframe src="https://open.spotify.com/embed/track/${trackId}?utm_source=generator&theme=0" width="100%" height="80" frameBorder="0" allow="autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture" style="border-radius:12px;"></iframe>`;
        
        if (window.innerWidth < 768) {
            showMobileSpotifyHint();
        }

        isPlaying = true;
        updatePlayPauseUI(true);
    }

    function finalizePlayback(trackId, isFullTrack) {
        const playerContainer = document.getElementById('youtube-player-container');
        // If it's a full track playing via API, we use a "cleaner" embed that doesn't scream "PREVIEW"
        const embedUrl = `https://open.spotify.com/embed/track/${trackId}?utm_source=generator&theme=0`;
        playerContainer.innerHTML = `<iframe src="${embedUrl}" width="100%" height="80" frameBorder="0" allow="autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture" style="border-radius:12px;"></iframe>`;
        
        isPlaying = true;
        updatePlayPauseUI(true);
        
        if (isFullTrack) {
            // Optional: Add a small indicator that it's playing full track via connected device
            console.log("Full track playing via active device.");
        }
    }

    function showMobileSpotifyHint() {
        const hint = document.createElement('div');
        hint.id = 'spotifyMobileHint';
        hint.style = "position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%); background: #1DB954; color: white; padding: 12px 20px; border-radius: 30px; font-size: 0.9rem; z-index: 1000; box-shadow: 0 4px 15px rgba(0,0,0,0.3); display: flex; align-items: center; gap: 10px; width: 90%; max-width: 400px;";
        hint.innerHTML = `
            <i class="fab fa-spotify"></i>
            <span>To get full tracks, make sure Spotify is open!</span>
            <button onclick="window.location.href='spotify:track:'; this.parentElement.remove();" style="background: white; color: #1DB954; border: none; padding: 5px 12px; border-radius: 15px; font-weight: 600; cursor: pointer;">Wake Up</button>
            <i class="fas fa-times" onclick="this.parentElement.remove()" style="margin-left: auto; cursor: pointer;"></i>
        `;
        document.body.appendChild(hint);
        setTimeout(() => hint.remove(), 8000);
    }

    function updatePlayPauseUI(playing) {
        const btn = document.getElementById('playPauseBtn');
        if (btn) btn.innerHTML = playing ? '<i class="fas fa-pause" style="color: black; font-size: 1.1rem;"></i>' : '<i class="fas fa-play" style="color: black; font-size: 1.1rem; margin-left: 3px;"></i>';
    }

    window.togglePlayPause = () => {
        // If we are using the Spotify Embed, we can't easily control it via JS 
        // because of cross-origin restrictions on the iframe.
        // We let the user click the play/pause button inside the Embed itself.
        // However, we can still toggle the UI state if we had a way to communicate.
        // For now, we'll just show a message or let the Embed handle it.
        if (audioPlayer.src && audioPlayer.src !== window.location.href) {
            if (isPlaying) {
                audioPlayer.pause();
            } else {
                audioPlayer.play();
            }
            isPlaying = !isPlaying;
            updatePlayPauseUI(isPlaying);
        } else {
            // If it's the Embed, the user should use the Embed's own controls.
            // We'll just update our local UI state for visual consistency.
            isPlaying = !isPlaying;
            updatePlayPauseUI(isPlaying);
        }
    };

    document.getElementById('progressContainer').onclick = (e) => {
        const rect = e.currentTarget.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const pct = x / rect.width;
        
        if (audioPlayer.src && audioPlayer.src !== window.location.href) {
            audioPlayer.currentTime = audioPlayer.duration * pct;
        }
    };

    document.getElementById('volumeSlider').addEventListener('input', (e) => {
        const vol = e.target.value;
        if (audioPlayer) audioPlayer.volume = vol / 100;
    });

    // --- LEGACY YOUTUBE SEARCH (Disabled) ---
    /*
    const youtubeSearchInput = document.getElementById('youtubeSearchInput');
    const youtubeSearchBtn = document.getElementById('youtubeSearchBtn');
    const youtubeResults = document.getElementById('youtubeResults');
    ...
    */
        if (player && player.setVolume) {
            player.setVolume(e.target.value);
        };

    youtubeSearchBtn.onclick = () => searchYouTube(youtubeSearchInput.value);
        youtubeSearchInput.onkeypress = (e) => {
            if (e.key === 'Enter') searchYouTube(youtubeSearchInput.value);
        };
    // (removed stray closing brace)

    // --- AUTH LOGIC ---
    function showMessage(msg, isError = false) {
        const div = document.getElementById('message');
        if (!div) return;
        div.textContent = msg;
        div.className = isError ? 'error' : 'success';
        div.style.display = 'block';
        console.log(`Auth Message: ${msg}`);
    }

    function initAuthButtons() {
        const signupBtn = document.getElementById('signupBtn');
        const loginBtn = document.getElementById('loginBtn');

        if (signupBtn) {
            signupBtn.onclick = async () => {
                const firstName = document.getElementById('firstName').value;
                const lastName = document.getElementById('lastName').value;
                const email = document.getElementById('signupEmail').value;
                const password = document.getElementById('signupPassword').value;
                const confirm = document.getElementById('confirmPassword').value;

                if (!firstName || !lastName || !email || !password || password !== confirm) {
                    return showMessage("Check all fields and password match", true);
                }

                signupBtn.disabled = true;
                signupBtn.textContent = "Creating...";

                try {
                    const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                    await updateProfile(userCredential.user, { displayName: `${firstName} ${lastName}` });
                    await sendEmailVerification(userCredential.user);
                    showMessage("Verification email sent! Please check your inbox.");
                } catch (error) {
                    showMessage(error.message, true);
                } finally {
                    signupBtn.disabled = false;
                    signupBtn.textContent = "Create Account";
                }
            };
        }

        if (loginBtn) {
            loginBtn.onclick = async () => {
                const email = document.getElementById('loginEmail').value;
                const password = document.getElementById('loginPassword').value;

                if (!email || !password) return showMessage("Please enter email and password", true);

                loginBtn.disabled = true;
                loginBtn.textContent = "Signing In...";

                try {
                    await signInWithEmailAndPassword(auth, email, password);
                    // onAuthStateChanged handles the rest
                } catch (error) {
                    showMessage(error.message, true);
                } finally {
                    loginBtn.disabled = false;
                    loginBtn.textContent = "Sign In";
                }
            };
        }
    }

    // Initial call
    initAuthButtons();
</script>

</body>
</html>

